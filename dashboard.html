<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - Urochithi</title>
<link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --color-bg: #faf8f3;
  --color-paper: #ffffff;
  --color-border: rgba(139, 69, 19, 0.15);
  --color-border-strong: rgba(139, 69, 19, 0.3);
  --color-primary: #8d6e63;
  --color-primary-dark: #6d4c41;
  --color-text: #5d4037;
  --color-text-muted: #8d6e63;
  --color-accent: rgba(139, 69, 19, 0.08);
  --shadow-sm: 0 2px 8px rgba(93, 64, 55, 0.08);
  --shadow-md: 0 4px 16px rgba(93, 64, 55, 0.12);
  --shadow-lg: 0 8px 32px rgba(93, 64, 55, 0.16);
  --radius: 4px;
  --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  background: var(--color-bg);
  background-image: 
    linear-gradient(90deg, rgba(139, 69, 19, 0.03) 1px, transparent 1px),
    linear-gradient(rgba(139, 69, 19, 0.03) 1px, transparent 1px);
  background-size: 24px 24px;
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  color: var(--color-text);
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Auth Screens */
.auth-container {
  max-width: 480px;
  margin: clamp(3rem, 10vh, 8rem) auto;
  padding: clamp(1rem, 3vw, 2rem);
}

.auth-card {
  background: var(--color-paper);
  padding: clamp(2rem, 5vw, 3.5rem);
  border: 2px solid var(--color-border);
  box-shadow: var(--shadow-lg);
  position: relative;
}

.auth-card::before {
  content: '';
  position: absolute;
  inset: -2px;
  border: 1px solid rgba(139, 69, 19, 0.05);
  pointer-events: none;
}

.auth-header {
  text-align: center;
  margin-bottom: 2.5rem;
}

.auth-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
  display: block;
  filter: grayscale(0.3);
}

.auth-title {
  font-family: 'Special Elite', monospace;
  font-size: clamp(1.5rem, 4vw, 2rem);
  color: var(--color-text);
  margin-bottom: 0.5rem;
  font-weight: 700;
  letter-spacing: -0.5px;
}

.auth-subtitle {
  font-size: 0.95rem;
  color: var(--color-text-muted);
  line-height: 1.6;
  font-weight: 400;
}

.auth-form {
  display: flex;
  flex-direction: column;
  gap: 1.75rem;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.form-label {
  font-size: 0.875rem;
  color: var(--color-text);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding-left: 0.25rem;
}

.form-input {
  padding: 1rem 1.25rem;
  border: 2px solid var(--color-border);
  background: var(--color-paper);
  font-family: 'Special Elite', monospace;
  font-size: 1.5rem;
  color: var(--color-text);
  outline: none;
  transition: var(--transition);
  text-align: center;
  letter-spacing: 3px;
  border-radius: var(--radius);
}

.form-input:focus {
  border-color: var(--color-primary);
  box-shadow: 0 0 0 4px rgba(141, 110, 99, 0.08);
}

.form-input::placeholder {
  opacity: 0.4;
}

.time-display {
  background: var(--color-accent);
  border: 2px dashed var(--color-border-strong);
  border-radius: var(--radius);
  padding: 2rem;
  text-align: center;
  margin-bottom: 0.5rem;
}

.time-label {
  font-size: 0.75rem;
  color: var(--color-text-muted);
  margin-bottom: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  font-weight: 600;
}

.time-value {
  font-size: clamp(2.5rem, 8vw, 4rem);
  color: var(--color-text);
  font-weight: 700;
  letter-spacing: 0.25rem;
  font-family: 'Courier New', monospace;
  line-height: 1;
}

.time-hint {
  font-size: 0.8rem;
  color: var(--color-text-muted);
  text-align: center;
  margin-top: 0.75rem;
  line-height: 1.5;
  padding: 0.75rem;
  background: rgba(139, 69, 19, 0.03);
  border-radius: var(--radius);
}

.auth-button {
  padding: 1.125rem 2rem;
  background: var(--color-primary);
  color: var(--color-paper);
  border: none;
  font-family: 'Inter', sans-serif;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  box-shadow: var(--shadow-sm);
  border-radius: var(--radius);
  letter-spacing: 0.5px;
  text-transform: uppercase;
  position: relative;
  overflow: hidden;
}

.auth-button::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(180deg, rgba(255,255,255,0.1), transparent);
  opacity: 0;
  transition: var(--transition);
}

.auth-button:hover:not(:disabled)::before {
  opacity: 1;
}

.auth-button:hover:not(:disabled) {
  background: var(--color-primary-dark);
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

.auth-button:active {
  transform: translateY(0);
}

.auth-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.auth-error {
  background: rgba(244, 67, 54, 0.08);
  color: #c62828;
  padding: 0.875rem 1rem;
  border-left: 3px solid #f44336;
  font-size: 0.875rem;
  display: none;
  border-radius: var(--radius);
  line-height: 1.5;
  font-weight: 500;
}

.auth-error.show {
  display: block;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-8px);
  }
}

.back-link {
  text-align: center;
  margin-top: 1.5rem;
  font-size: 0.875rem;
  color: var(--color-text-muted);
  cursor: pointer;
  transition: var(--transition);
  font-weight: 500;
  padding: 0.5rem;
}

.back-link:hover {
  color: var(--color-text);
}

/* Dashboard */
.dashboard-container {
  display: none;
  min-height: 100vh;
}

.dashboard-container.show {
  display: flex;
  flex-direction: column;
}

.dashboard-nav {
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(12px) saturate(180%);
  border-bottom: 1px solid var(--color-border);
  padding: 1rem 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 1px 3px rgba(93, 64, 55, 0.05);
}

.nav-brand {
  font-family: 'Special Elite', monospace;
  font-size: 1.25rem;
  color: var(--color-text);
  font-weight: 700;
  letter-spacing: -0.5px;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.nav-actions {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.nav-btn {
  padding: 0.625rem 1.125rem;
  background: transparent;
  color: var(--color-text);
  border: 1px solid var(--color-border);
  font-family: 'Inter', sans-serif;
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 0.375rem;
  border-radius: var(--radius);
}

.nav-btn:hover {
  background: var(--color-accent);
  border-color: var(--color-border-strong);
  transform: translateY(-1px);
}

.nav-btn:active {
  transform: translateY(0);
}

.nav-btn.primary {
  background: var(--color-primary);
  color: var(--color-paper);
  border-color: var(--color-primary);
}

.nav-btn.primary:hover {
  background: var(--color-primary-dark);
  border-color: var(--color-primary-dark);
}

.dashboard-content {
  flex: 1;
  max-width: 1440px;
  width: 100%;
  margin: 0 auto;
  padding: clamp(1.5rem, 4vw, 3rem) clamp(1rem, 4vw, 2rem);
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 1.25rem;
  margin-bottom: 2.5rem;
}

.stat-card {
  background: var(--color-paper);
  padding: 1.75rem;
  border: 1px solid var(--color-border);
  transition: var(--transition);
  box-shadow: var(--shadow-sm);
  border-radius: var(--radius);
  position: relative;
  overflow: hidden;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--color-primary), var(--color-primary-dark));
  opacity: 0;
  transition: var(--transition);
}

.stat-card:hover {
  border-color: var(--color-primary);
  box-shadow: var(--shadow-md);
  transform: translateY(-2px);
}

.stat-card:hover::before {
  opacity: 1;
}

.stat-label {
  font-size: 0.75rem;
  color: var(--color-text-muted);
  margin-bottom: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  font-weight: 600;
}

.stat-value {
  font-size: 2.5rem;
  color: var(--color-text);
  font-weight: 700;
  line-height: 1;
  letter-spacing: -1px;
}

.controls-section {
  background: var(--color-paper);
  padding: 1.5rem;
  border: 1px solid var(--color-border);
  border-radius: var(--radius);
  margin-bottom: 1.5rem;
  box-shadow: var(--shadow-sm);
}

.controls {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
  align-items: center;
}

.search-wrapper {
  flex: 1;
  min-width: 280px;
  position: relative;
}

.search-icon {
  position: absolute;
  left: 1rem;
  top: 50%;
  transform: translateY(-50%);
  color: var(--color-text-muted);
  pointer-events: none;
  font-size: 1rem;
}

.search-input {
  width: 100%;
  padding: 0.875rem 1rem 0.875rem 2.75rem;
  border: 1px solid var(--color-border);
  background: var(--color-paper);
  font-family: 'Inter', sans-serif;
  font-size: 0.875rem;
  color: var(--color-text);
  transition: var(--transition);
  border-radius: var(--radius);
}

.search-input:focus {
  outline: none;
  border-color: var(--color-primary);
  box-shadow: 0 0 0 3px rgba(141, 110, 99, 0.08);
}

.search-input::placeholder {
  color: var(--color-text-muted);
  opacity: 0.6;
}

.filter-select {
  padding: 0.875rem 2.5rem 0.875rem 1rem;
  border: 1px solid var(--color-border);
  background: var(--color-paper);
  font-family: 'Inter', sans-serif;
  font-size: 0.875rem;
  color: var(--color-text);
  cursor: pointer;
  transition: var(--transition);
  border-radius: var(--radius);
  font-weight: 500;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%238d6e63' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 0.875rem center;
}

.filter-select:focus {
  outline: none;
  border-color: var(--color-primary);
  box-shadow: 0 0 0 3px rgba(141, 110, 99, 0.08);
}

.messages-wrapper {
  background: var(--color-paper);
  border: 1px solid var(--color-border);
  border-radius: var(--radius);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
}

.messages-table {
  width: 100%;
  border-collapse: collapse;
}

.messages-table thead {
  background: var(--color-accent);
  position: sticky;
  top: 0;
  z-index: 10;
}

.messages-table th {
  padding: 1rem 1.25rem;
  text-align: left;
  font-size: 0.75rem;
  color: var(--color-text);
  font-weight: 700;
  border-bottom: 1px solid var(--color-border);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.messages-table tbody tr {
  border-bottom: 1px solid var(--color-border);
  transition: var(--transition);
}

.messages-table tbody tr:last-child {
  border-bottom: none;
}

.messages-table tbody tr:hover {
  background: rgba(139, 69, 19, 0.02);
}

.messages-table td {
  padding: 1.125rem 1.25rem;
  color: var(--color-text);
  font-size: 0.875rem;
  vertical-align: top;
  line-height: 1.6;
}

.message-text {
  max-width: 600px;
  word-wrap: break-word;
  color: var(--color-text);
}

.session-id {
  font-family: 'Courier New', monospace;
  font-size: 0.8rem;
  color: var(--color-text-muted);
  background: rgba(139, 69, 19, 0.04);
  padding: 0.25rem 0.5rem;
  border-radius: 3px;
  display: inline-block;
}

.timestamp {
  font-size: 0.8rem;
  color: var(--color-text-muted);
  white-space: nowrap;
  font-weight: 500;
}

.loading-screen,
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 4rem 2rem;
  text-align: center;
}

.spinner {
  width: 48px;
  height: 48px;
  border: 3px solid var(--color-border);
  border-top-color: var(--color-primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-bottom: 1.5rem;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text,
.empty-state-text {
  font-size: 0.95rem;
  color: var(--color-text-muted);
  font-weight: 500;
}

@media (max-width: 768px) {
  .dashboard-nav {
    flex-direction: column;
    gap: 1rem;
    padding: 1rem;
  }
  
  .nav-actions {
    width: 100%;
    justify-content: stretch;
  }
  
  .nav-btn {
    flex: 1;
    justify-content: center;
  }
  
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .controls {
    flex-direction: column;
  }
  
  .search-wrapper,
  .filter-select {
    width: 100%;
  }
  
  .messages-table th,
  .messages-table td {
    padding: 0.875rem;
    font-size: 0.8rem;
  }
  
  .message-text {
    max-width: 100%;
  }
  
  .stat-value {
    font-size: 2rem;
  }
}

@media (max-width: 480px) {
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  .time-value {
    font-size: 2.5rem;
  }
}
</style>
</head>
<body>

<!-- Step 1: Static PIN -->
<div id="step1Container" class="auth-container">
  <div class="auth-card">
    <div class="auth-header">
      <span class="auth-icon">üîê</span>
      <h1 class="auth-title">Dashboard Login</h1>
      <p class="auth-subtitle">Enter your PIN to continue</p>
    </div>
    
    <form id="step1Form" class="auth-form">
      <div class="form-group">
        <label class="form-label">PIN</label>
        <input 
          type="password" 
          id="staticPin" 
          class="form-input" 
          placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
          autocomplete="off"
          required
        >
      </div>
      
      <div id="step1Error" class="auth-error"></div>
      
      <button type="submit" class="auth-button" id="step1Button">
        Continue
      </button>
    </form>
  </div>
</div>

<!-- Step 2: Time-based PIN -->
<div id="step2Container" class="auth-container" style="display: none;">
  <div class="auth-card">
    <div class="auth-header">
      <span class="auth-icon">‚è∞</span>
      <h1 class="auth-title">Time Verification</h1>
      <p class="auth-subtitle">Calculate and enter the time-based code</p>
    </div>
    
    <div class="time-display">
      <div class="time-label">Current UTC Time</div>
      <div class="time-value" id="utcTime">--:--</div>
    </div>
    
    <form id="step2Form" class="auth-form">
      <div class="form-group">
        <label class="form-label">Time-based Code</label>
        <input 
          type="number" 
          id="timePin" 
          class="form-input" 
          placeholder="000" 
          autocomplete="off"
          required
        >
        <div class="time-hint">
          Use the formula with current UTC time shown above
        </div>
      </div>
      
      <div id="step2Error" class="auth-error"></div>
      
      <button type="submit" class="auth-button" id="step2Button">
        Authenticate
      </button>
    </form>
    
    <div class="back-link" id="backToStep1">‚Üê Back to PIN</div>
  </div>
</div>

<!-- Dashboard -->
<div id="dashboardContainer" class="dashboard-container">
  <!-- Navigation Bar -->
  <nav class="dashboard-nav">
    <div class="nav-brand">
      <span>üìä</span>
      <span>Dashboard</span>
    </div>
    <div class="nav-actions">
      <button class="nav-btn" id="refreshBtn">
        <span>‚Üª</span>
        <span>Refresh</span>
      </button>
      <a href="/" class="nav-btn">Home</a>
      <button class="nav-btn primary" id="logoutBtn">Logout</button>
    </div>
  </nav>
  
  <!-- Content -->
  <div class="dashboard-content">
    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Messages</div>
        <div class="stat-value" id="totalMessages">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Today</div>
        <div class="stat-value" id="todayMessages">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Unique Sessions</div>
        <div class="stat-value" id="uniqueSessions">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">This Week</div>
        <div class="stat-value" id="weekMessages">0</div>
      </div>
    </div>
    
    <!-- Controls -->
    <div class="controls-section">
      <div class="controls">
        <div class="search-wrapper">
          <span class="search-icon">üîç</span>
          <input 
            type="text" 
            id="searchInput" 
            class="search-input" 
            placeholder="Search messages or session IDs..."
          >
        </div>
        <select id="sortSelect" class="filter-select">
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
        </select>
        <select id="filterSelect" class="filter-select">
          <option value="all">All Messages</option>
          <option value="today">Today</option>
          <option value="week">This Week</option>
          <option value="month">This Month</option>
        </select>
      </div>
    </div>
    
    <!-- Messages -->
    <div class="messages-wrapper">
      <div id="messagesContainer">
        <div class="loading-screen">
          <div class="spinner"></div>
          <div class="loading-text">Loading messages...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const AUTH_KEY = 'urochithi_dashboard_auth';
const SESSION_TIMEOUT = 30 * 60 * 1000;

let messages = [];
let filteredMessages = [];
let lastActivity = Date.now();
let staticPinValue = '';

function updateUTCTime() {
  const now = new Date();
  const hours = String(now.getUTCHours()).padStart(2, '0');
  const minutes = String(now.getUTCMinutes()).padStart(2, '0');
  
  const timeEl = document.getElementById('utcTime');
  if (timeEl) {
    timeEl.textContent = `${hours}:${minutes}`;
  }
}

setInterval(updateUTCTime, 1000);
updateUTCTime();

function checkAuth() {
  const auth = localStorage.getItem(AUTH_KEY);
  if (auth) {
    const authData = JSON.parse(auth);
    const now = Date.now();
    
    if (now - authData.timestamp < SESSION_TIMEOUT) {
      lastActivity = now;
      showDashboard();
      loadMessages();
      return true;
    } else {
      localStorage.removeItem(AUTH_KEY);
    }
  }
  return false;
}

document.addEventListener('click', () => lastActivity = Date.now());
document.addEventListener('keypress', () => lastActivity = Date.now());

setInterval(() => {
  if (Date.now() - lastActivity > SESSION_TIMEOUT) {
    logout();
  }
}, 60000);

document.getElementById('step1Form').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const staticPin = document.getElementById('staticPin').value;
  const errorDiv = document.getElementById('step1Error');
  const button = document.getElementById('step1Button');
  
  errorDiv.classList.remove('show');
  button.disabled = true;
  button.textContent = 'Verifying...';
  
  try {
    const response = await fetch('/.netlify/functions/verify-static-pin', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ staticPin })
    });
    
    const data = await response.json();
    
    if (response.ok && data.valid) {
      staticPinValue = staticPin;
      document.getElementById('step1Container').style.display = 'none';
      document.getElementById('step2Container').style.display = 'block';
    } else {
      errorDiv.textContent = data.error || 'Invalid PIN';
      errorDiv.classList.add('show');
    }
  } catch (error) {
    errorDiv.textContent = 'Connection error. Please try again.';
    errorDiv.classList.add('show');
  } finally {
    button.disabled = false;
    button.textContent = 'Continue';
  }
});

document.getElementById('backToStep1').addEventListener('click', () => {
  document.getElementById('step2Container').style.display = 'none';
  document.getElementById('step1Container').style.display = 'block';
  document.getElementById('staticPin').value = '';
  staticPinValue = '';
});

document.getElementById('step2Form').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const timePin = document.getElementById('timePin').value;
  const errorDiv = document.getElementById('step2Error');
  const button = document.getElementById('step2Button');
  
  errorDiv.classList.remove('show');
  button.disabled = true;
  button.textContent = 'Authenticating...';
  
  try {
    const response = await fetch('/.netlify/functions/verify-time-pin', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ staticPin: staticPinValue, timePin })
    });
    
    const data = await response.json();
    
    if (response.ok && data.authenticated) {
      localStorage.setItem(AUTH_KEY, JSON.stringify({
        authenticated: true,
        timestamp: Date.now()
      }));
      showDashboard();
      loadMessages();
    } else {
      errorDiv.textContent = data.error || 'Invalid code';
      errorDiv.classList.add('show');
    }
  } catch (error) {
    errorDiv.textContent = 'Connection error. Please try again.';
    errorDiv.classList.add('show');
  } finally {
    button.disabled = false;
    button.textContent = 'Authenticate';
  }
});

function showDashboard() {
  document.getElementById('step1Container').style.display = 'none';
  document.getElementById('step2Container').style.display = 'none';
  document.getElementById('dashboardContainer').classList.add('show');
}

function logout() {
  localStorage.removeItem(AUTH_KEY);
  location.reload();
}

document.getElementById('logoutBtn').addEventListener('click', logout);

async function loadMessages() {
  const container = document.getElementById('messagesContainer');
  container.innerHTML = '<div class="loading-screen"><div class="spinner"></div><div class="loading-text">Loading messages...</div></div>';
  
  try {
    const response = await fetch('/.netlify/functions/get-messages', {
      headers: {
        'Authorization': JSON.stringify(JSON.parse(localStorage.getItem(AUTH_KEY)))
      }
    });
    
    if (!response.ok) throw new Error('Failed to load');
    
    const data = await response.json();
    messages = data.messages || [];
    
    updateStats();
    filterAndDisplayMessages();
  } catch (error) {
    container.innerHTML = '<div class="empty-state"><div class="empty-state-text">Error loading messages. Please refresh.</div></div>';
  }
}

function updateStats() {
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
  
  const todayCount = messages.filter(m => new Date(m.timestamp) >= today).length;
  const weekCount = messages.filter(m => new Date(m.timestamp) >= weekAgo).length;
  const uniqueSessions = new Set(messages.map(m => m.sessionId)).size;
  
  document.getElementById('totalMessages').textContent = messages.length;
  document.getElementById('todayMessages').textContent = todayCount;
  document.getElementById('uniqueSessions').textContent = uniqueSessions;
  document.getElementById('weekMessages').textContent = weekCount;
}

function filterAndDisplayMessages() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const sortBy = document.getElementById('sortSelect').value;
  const filterBy = document.getElementById('filterSelect').value;
  
  filteredMessages = messages.filter(msg => {
    if (searchTerm && !msg.message.toLowerCase().includes(searchTerm) && 
        !msg.sessionId.toLowerCase().includes(searchTerm)) {
      return false;
    }
    
    const msgDate = new Date(msg.timestamp);
    const now = new Date();
    
    if (filterBy === 'today') {
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      if (msgDate < today) return false;
    } else if (filterBy === 'week') {
      const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      if (msgDate < weekAgo) return false;
    } else if (filterBy === 'month') {
      const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
      if (msgDate < monthAgo) return false;
    }
    
    return true;
  });
  
  filteredMessages.sort((a, b) => {
    const dateA = new Date(a.timestamp);
    const dateB = new Date(b.timestamp);
    return sortBy === 'newest' ? dateB - dateA : dateA - dateB;
  });
  
  displayMessages();
}

function displayMessages() {
  const container = document.getElementById('messagesContainer');
  
  if (filteredMessages.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="empty-state-text">No messages found.</div></div>';
    return;
  }
  
  const table = `
    <table class="messages-table">
      <thead>
        <tr>
          <th style="width: 180px">Timestamp</th>
          <th>Message</th>
          <th style="width: 200px">Session ID</th>
        </tr>
      </thead>
      <tbody>
        ${filteredMessages.map(msg => `
          <tr>
            <td class="timestamp">${formatDate(msg.timestamp)}</td>
            <td class="message-text">${escapeHtml(msg.message)}</td>
            <td><span class="session-id">${msg.sessionId}</span></td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
  
  container.innerHTML = table;
}

function formatDate(dateString) {
  const date = new Date(dateString);
  const now = new Date();
  const diff = now - date;
  
  if (diff < 60000) return 'Just now';
  if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
  if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
  
  return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

document.getElementById('searchInput').addEventListener('input', filterAndDisplayMessages);
document.getElementById('sortSelect').addEventListener('change', filterAndDisplayMessages);
document.getElementById('filterSelect').addEventListener('change', filterAndDisplayMessages);
document.getElementById('refreshBtn').addEventListener('click', loadMessages);

checkAuth();
</script>
</body>
</html>